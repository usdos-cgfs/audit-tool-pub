(()=>{var Se=String.raw,te=Se`
  <div class="audit">
    <div id="divLoading" style="color: green">Loading...</div>
    <div id="divLoadSettings" style="display: none">
      <fieldset>
        <legend>
          Add Responses to Request Number:
          <span id="divRequestNumber" style="font-weight: bold"></span>
        </legend>
        <div style="padding-top: 10px">
          <a href="javascript:void" id="btnUploadResponses"
            ><span class="ui-icon ui-icon-gear"></span>Upload Responses to be
            Created</a
          >
        </div>
        <div style="padding-top: 10px">
          <a href="javascript:void" id="btnLoadResponses" style="display: none"
            >Click Here to Display Uploaded Responses</a
          >
        </div>
      </fieldset>
    </div>
    <div id="divLoadBulkResponsesOutput" style="padding-top: 15px"></div>
    <div style="padding-top: 15px">
      <a
        href="javascript:void"
        id="btnCreateResponses"
        style="display: none"
        title="Click here to Create the Responses"
        ><span class="ui-icon ui-icon-disk"></span>Create Responses</a
      >
      <div style="padding-top: 15px">
        <input
          id="btnCancel"
          type="button"
          class="ms-ButtonHeightWidth"
          value="Close"
          title="Close"
          onclick="SP.UI.ModalDialog.commonModalDialogClose(SP.UI.DialogResult.cancel)"
        />
      </div>
    </div>
  </div>
`;var n=window.Audit||{};n.BulkAddResponse=n.BulkAddResponse||{};document.readyState==="ready"||document.readyState==="complete"?ie():document.onreadystatechange=()=>{(document.readyState==="complete"||document.readyState==="ready")&&ExecuteOrDelayUntilScriptLoaded(function(){SP.SOD.executeFunc("sp.js","SP.ClientContext",ie)},"sp.js")};function ie(){document.getElementById("app").innerHTML=te,n.BulkAddResponse.Report=new n.BulkAddResponse.Load,n.BulkAddResponse.Init()}n.BulkAddResponse.Init=function(){};n.BulkAddResponse.Load=function(){var y=GetUrlKeyValue("ReqNum");if(y==null||y==""||y==null){var P=SP.UI.Status.addStatus("Error: Request Number was not specified. Please verify the URL Parameters or Launch from the IA Dashboard");SP.UI.Status.setStatusPriColor(P,"red");return}$("#divRequestNumber").text(y);var O=null,D=new Array,x=new Array,w=new Array,W=null,q,I,Q,E,F,k,ae=null,ne=null,oe=null;se();function se(){$("#divTblOutput").html("");var i=new SP.ClientContext.get_current,t=i.get_web(),e=t.get_lists().getByTitle(n.Common.Utilities.GetListTitleRequests()),a=new SP.CamlQuery;a.set_viewXml('<View><Query><OrderBy><FieldRef Name="Title"/></OrderBy></Query></View>'),q=e.getItems(a),i.load(q,"Include(ID, Title, ReqSubject, ReqStatus, IsSample, ReqDueDate, InternalDueDate, ActionOffice)");var c=t.get_lists().getByTitle(n.Common.Utilities.GetListTitleResponses()),g=new SP.CamlQuery;g.set_viewXml('<View Scope="RecursiveAll"><Query><OrderBy><FieldRef Name="ReqNum"/></OrderBy></Query></View>'),I=c.getItems(g),i.load(I,"Include(ID, Title, ReqNum, ActionOffice, SampleNumber)");var S=t.get_lists().getByTitle(n.Common.Utilities.GetLibTitleResponseDocs()),p=new SP.CamlQuery;p.set_viewXml('<View><Query><OrderBy><FieldRef Name="Name"/></OrderBy><Where><Eq><FieldRef Name="FSObjType" /><Value Type="Lookup">1</Value></Eq></Where></Query></View>'),p.set_folderServerRelativeUrl(n.Common.Utilities.GetSiteUrl()+"/"+n.Common.Utilities.GetLibNameResponseDocs()),Q=S.getItems(p),i.load(Q,"Include( DisplayName, Id, ContentType)");var R=t.get_lists().getByTitle(n.Common.Utilities.GetListTitleActionOffices()),l=new SP.CamlQuery;l.set_viewXml('<View><Query><OrderBy><FieldRef Name="Title"/></OrderBy></Query></View>'),E=R.getItems(l),i.load(E,"Include(ID, Title, UserGroup)");var s=i.get_web().get_lists().getByTitle(n.Common.Utilities.GetListNameBulkResponses());F=s.get_views().getByTitle("All Items"),i.load(F),k=t.get_siteGroups(),i.load(k);var u=t.get_associatedOwnerGroup(),h=t.get_associatedMemberGroup(),f=t.get_associatedVisitorGroup();i.load(u),i.load(h),i.load(f),i.executeQueryAsync(C,o);function C(b,m){if($("#divLoadSettings").show(),$("#divLoading").hide(),W=F.get_id(),n.Common.Utilities.LoadSiteGroups(k),n.Common.Utilities.LoadActionOffices(E),ae=u.get_title(),ne=h.get_title(),oe=f.get_title(),le(),O==null||O.number==null){P=SP.UI.Status.addStatus("Error: Request Number does not exist in the Request List. Please verify the URL Parameters and that the Request Number already exists"),SP.UI.Status.setStatusPriColor(P,"red"),$("#divLoadSettings").hide();return}de(),ue(),ge();var v=GetUrlKeyValue("IsDlg");(v==null||v==""||v==!1)&&$("#btnRefresh").show()}function o(b,m){$("#divLoading").hide(),P=SP.UI.Status.addStatus("Request failed: "+m.get_message()+`
`+m.get_stackTrace()),SP.UI.Status.setStatusPriColor(P,"red")}}function re(){var i=location.pathname,t=$("#tabs").tabs("option","active");i+="?Tab="+t,location.href=i}function le(){for(var i=SP.ClientContext.get_current(),t=i.get_web(),e=q.getEnumerator();e.moveNext();){var a=e.get_current(),c=a.get_item("ID"),g=a.get_item("Title");if(g==y){for(var S=a.get_item("ReqStatus"),p=a.get_item("IsSample"),R=a.get_item("ActionOffice"),l="",s=0;s<R.length;s++)l+="<div>"+R[s].get_lookupValue()+"</div>";var u=new Object;u.ID=c,u.number=g,u.status=S,u.sample=p,u.responses=new Array,u.actionOffice=l,u.item=a,O=u}}}function de(){D=new Array;for(var i=I.getEnumerator();i.moveNext();){var t=i.get_current(),e=t.get_item("ReqNum");if(e!=null){if(e=e.get_lookupValue(),e!=y)continue;var a=new Object;a.ID=t.get_item("ID"),a.number=e,a.title=t.get_item("Title"),a.item=t,a.sample=t.get_item("SampleNumber"),a.sample==null&&(a.sample=""),a.actionOffice=t.get_item("ActionOffice"),a.actionOffice==null?a.actionOffice="":a.actionOffice=a.actionOffice.get_lookupValue(),D.push(a)}}}function ue(){for(var i=new Array,t=Q.getEnumerator();t.moveNext();)for(var e=t.get_current(),a=e.get_displayName(),c=0;c<D.length;c++)if(D[c].title==a){var g=new Object;g.title=a,g.response=D[c],i.push(g);break}}function me(){var i="DispForm.aspx",t=SP.UI.$create_DialogOptions();t.title="Upload Responses ("+y+")",t.dialogReturnValueCallback=pe;var e=W.toString();e=e.replace(/-/g,"%2D"),e=e.toUpperCase(),t.url=n.Common.Utilities.GetSiteUrl()+"/Lists/"+n.Common.Utilities.GetListNameBulkResponses()+"/AllItems.aspx?ShowInGrid=True&View=%7B"+e+"%7D",t.height=700,SP.UI.ModalDialog.showModalDialog(t)}var X={isNotEmpty:function(i){var t=/\S+/;return t.test(i)},isNumber:function(i){var t=/^\d+$/;return t.test(i)}};function H(){w=new Array;var i=new SP.ClientContext.get_current,t=i.get_web(),e=t.get_lists().getByTitle(n.Common.Utilities.GetListTitleBulkResponses()),a=new SP.CamlQuery;a.set_viewXml('<View><Query><OrderBy><FieldRef Name="ID"/></OrderBy></Query></View>');var c=e.getItems(a);i.load(c,"Include(ID, Title, ActionOffice, Comments, POC, POCCC)");function g(p,R){for(var l=c.getEnumerator();l.moveNext();){var s=l.get_current(),u=s.get_item("ID"),h=s.get_item("Title"),f=s.get_item("ActionOffice").get_lookupValue(),C=s.get_item("Comments");C==null&&(C="");var o=new Object;o.ID=u,o.sampleNumber=h,o.actionOffice=f,o.comments=C;var b=y+"-"+f+"-"+h;o.responseTitle=b,o.item=s,f&&f.toLowerCase().indexOf("fpra")<0?(o.poc="",o.poccc="",o.pocID="",o.pocccID=""):(o.poc="",o.poccc="",o.pocID="",o.pocccID="",s.get_item("POC")!=null&&s.get_item("POC").get_lookupValue()!=null&&(o.poc=s.get_item("POC").get_lookupValue(),o.pocID=s.get_item("POC").get_lookupId()),s.get_item("POCCC")!=null&&s.get_item("POCCC").get_lookupValue()!=null&&(o.poccc=s.get_item("POCCC").get_lookupValue(),o.pocccID=s.get_item("POCCC").get_lookupId()));var m=!0,v=null;if((!X.isNotEmpty(h)||!X.isNumber(h))&&(m=!1,v="Invalid sample number"),m){for(var r=0;r<D.length;r++)if(D[r].title==b){m=!1,v="Response with this name exists";break}}if(m){for(var r=0;r<x.length;r++)if(x[r].title==b){m=!1,v="Response Folder with this name exists";break}}if(m){for(var _=!1,r=0;r<n.Common.Utilities.GetActionOffices().length;r++)n.Common.Utilities.GetActionOffices()[r].title==f&&(o.actionOfficeID=n.Common.Utilities.GetActionOffices()[r].ID,_=!0);_||(m=!1,v="Action Office not found")}o.isValid=m,o.invalidReason=v,w.push(o)}var G=!1;w.sort(function(N,A){return N=parseInt(N.sampleNumber,10),A=parseInt(A.sampleNumber,10),N-A});for(var T="<table class='tablesorter report'><tr><thead><th>Request Number</th><th>Action Office</th><th>Sample Number</th><th>Response Title</th><th>Comments</th><th>POC</th><th>POC CC</th></thead></tr>",r=0;r<w.length;r++){var d=w[r];d.isValid?(T+="<tr id='tableRow"+r+"'><td id='tdReq"+r+"'>"+y+"</td><td>"+d.actionOffice+"</td><td>"+d.sampleNumber+"</td><td>"+d.responseTitle+"</td><td>"+d.comments+"</td><td>"+d.poc+"</td><td>"+d.poccc+"</td></tr>",G=!0):T+="<tr style='background-color:lightsalmon; font-style:italic;' title='"+d.invalidReason+"'><td>"+y+"</td><td>"+d.actionOffice+"</td><td>"+d.sampleNumber+"</td><td>"+d.responseTitle+" - "+d.invalidReason+"</td><td>"+d.comments+"</td><td>"+d.poc+"</td><td>"+d.poccc+"</td></tr>"}$("#divLoadBulkResponsesOutput").html(T+="<tfoot><tr><th colspan='7'>Total: "+w.length+"</tr></tfoot></table>"),w.length==0&&$("#divLoadBulkResponsesOutput").html(""),G?$("#btnCreateResponses").show().focus():$("#btnCreateResponses").hide()}function S(p,R){P=SP.UI.Status.addStatus("Unable to load from the Bulk Response List: "+R.get_message()+`
`+R.get_stackTrace()),SP.UI.Status.setStatusPriColor(P,"red")}i.executeQueryAsync(g,S)}var B=0,U=0,V=null,L=!0;function ce(){if(L=!0,confirm("Are you sure you would like to Create the Responses?")){$("#btnUploadResponses").hide(),$("#btnCreateResponses").hide(),$("#divLoadSettings").hide(),$("#btnCancel").hide(),document.body.style.cursor="wait",window.parent!=null&&window.parent.document.getElementById("divRanBulkUpdate")!=null&&(window.parent.document.getElementById("divRanBulkUpdate").innerText=1),V=SP.UI.ModalDialog.showWaitScreenWithNoClose("Creating Responses","Please wait... Creating Responses",200,400);for(var i=0;i<w.length;i++){var t=w[i];if(t.isValid){let ve=function(ye,j){L&&(n.Common.Utilities.CheckIfEmailFolderExists(this.emailListFolderItems,this.requestNumber)||n.Common.Utilities.CreateEmailFolder(this.emailList,this.requestNumber),L=!1),$("#tableRow"+this.tableRowId).attr("style","background-color:palegreen"),$("#tableRow"+this.tableRowId).attr("title","Created"),$("#tdReq"+this.tableRowId).html("<span class='ui-icon ui-icon-check'></span> "+$("#tdReq"+this.tableRowId).text());var ee=new SP.ClientContext.get_current,M=w[this.tableRowId].ID;if(M!=null&&M>=0){var we=ee.get_web().get_lists().getByTitle(n.Common.Utilities.GetListTitleBulkResponses()),Re=we.getItemById(M);Re.deleteObject()}ee.executeQueryAsync(function(){if(U++,B==U){document.body.style.cursor="default",V.close();var he=SP.UI.Notify.addNotification("Completed",!1);$("#btnCancel").show()}},function(){if(U++,B==U){document.body.style.cursor="default",V.close();var he=SP.UI.Notify.addNotification("Completed",!1);$("#btnCancel").show()}})},_e=function(ye,j){$("#tableRow"+this.tableRowId).attr("style","background-color:salmon"),$("#tableRow"+this.tableRowId).attr("title",j.get_message()),U++,B==U&&(document.body.style.cursor="default",V.close(),notifyId=SP.UI.Notify.addNotification("Completed",!1),$("#btnCancel").show())};B++;var e=new SP.ClientContext.get_current,a=e.get_web().get_currentUser(),c=e.get_web().get_associatedOwnerGroup(),g=e.get_web().get_associatedMemberGroup(),S=e.get_web().get_associatedVisitorGroup(),p=t.responseTitle,R=e.get_web().get_lists().getByTitle(n.Common.Utilities.GetListTitleResponses()),r=new SP.ListItemCreationInformation,l=R.addItem(r);if(l.set_item("Title",p),l.set_item("ReqNum",O.ID),l.set_item("SampleNumber",t.sampleNumber),l.set_item("ActionOffice",t.actionOfficeID),t.poc!=""){var s=new SP.FieldUserValue;s.set_lookupId(t.pocID),l.set_item("POC",s)}if(t.poccc!=""){var s=new SP.FieldUserValue;s.set_lookupId(t.pocccID),l.set_item("POCCC",s)}l.update(),l.breakRoleInheritance(!1,!1);var u=SP.RoleDefinitionBindingCollection.newObject(e);u.add(e.get_web().get_roleDefinitions().getByType(SP.RoleType.administrator));var h=SP.RoleDefinitionBindingCollection.newObject(e);h.add(e.get_web().get_roleDefinitions().getByType(SP.RoleType.contributor));var f=SP.RoleDefinitionBindingCollection.newObject(e);f.add(e.get_web().get_roleDefinitions().getByName("Restricted Read"));var C=SP.RoleDefinitionBindingCollection.newObject(e);C.add(e.get_web().get_roleDefinitions().getByName("Restricted Contribute")),l.get_roleAssignments().add(c,u),l.get_roleAssignments().add(g,h),l.get_roleAssignments().add(S,f);var o=l.get_item("ActionOffice");if(o!=null){var b=t.actionOffice,N=n.Common.Utilities.GetAOSPGroupName(b),m=n.Common.Utilities.GetSPSiteGroup(N);if(m!=null)l.get_roleAssignments().add(m,C);else return}l.get_roleAssignments().getByPrincipal(a).deleteObject();var v=e.get_web().get_lists().getByTitle(n.Common.Utilities.GetLibTitleResponseDocs()),r=new SP.ListItemCreationInformation;r.set_underlyingObjectType(SP.FileSystemObjectType.folder),r.set_leafName(p);var _=v.addItem(r);_.set_item("Title",p),_.update(),_.breakRoleInheritance(!1,!1);var G=SP.RoleDefinitionBindingCollection.newObject(e);G.add(e.get_web().get_roleDefinitions().getByType(SP.RoleType.administrator)),_.get_roleAssignments().add(c,G);var T=SP.RoleDefinitionBindingCollection.newObject(e);T.add(e.get_web().get_roleDefinitions().getByType(SP.RoleType.contributor)),_.get_roleAssignments().add(g,T);var d=SP.RoleDefinitionBindingCollection.newObject(e);d.add(e.get_web().get_roleDefinitions().getByName("Restricted Read")),_.get_roleAssignments().add(S,d);var N=n.Common.Utilities.GetAOSPGroupName(t.actionOffice),A=n.Common.Utilities.GetSPSiteGroup(N);if(A!=null){var K=SP.RoleDefinitionBindingCollection.newObject(e);K.add(e.get_web().get_roleDefinitions().getByName("Restricted Contribute")),_.get_roleAssignments().add(A,K)}_.get_roleAssignments().getByPrincipal(a).deleteObject();var z=e.get_web().get_lists().getByTitle(n.Common.Utilities.GetListTitleEmailHistory()),J=new SP.CamlQuery;J.set_viewXml('<View><Query><OrderBy><FieldRef Name="ID"/></OrderBy><Where><Eq><FieldRef Name="FSObjType"/><Value Type="Text">1</Value></Eq></Where></Query></View>');var Y=z.getItems(J);e.load(Y,"Include(ID, FSObjType, Title, DisplayName)");var Z={responseTitle:p,requestNumber:O.number,tableRowId:i,emailList:z,emailListFolderItems:Y};e.executeQueryAsync(Function.createDelegate(Z,ve),Function.createDelegate(Z,_e))}}}}function ge(){$("#btnUploadResponses").click(function(){me()}),$("#btnLoadResponses").click(function(){H()}),$("#btnCreateResponses").click(function(){ce()})}function pe(i,t){H()}var fe={Refresh:re};return fe};})();
