(()=>{var he=String.raw,ee=he`
  <div class="audit">
    <div id="divLoading" style="color: green">Loading...</div>
    <div id="divLoadSettings" style="display: none">
      <fieldset>
        <legend>
          Add Responses to Request Number:
          <span id="divRequestNumber" style="font-weight: bold"></span>
        </legend>
        <div style="padding-top: 10px">
          <a href="javascript:void" id="btnUploadResponses"
            ><span class="ui-icon ui-icon-gear"></span>Upload Responses to be
            Created</a
          >
        </div>
        <div style="padding-top: 10px">
          <a href="javascript:void" id="btnLoadResponses" style="display: none"
            >Click Here to Display Uploaded Responses</a
          >
        </div>
      </fieldset>
    </div>
    <div id="divLoadBulkResponsesOutput" style="padding-top: 15px"></div>
    <div style="padding-top: 15px">
      <a
        href="javascript:void"
        id="btnCreateResponses"
        style="display: none"
        title="Click here to Create the Responses"
        ><span class="ui-icon ui-icon-disk"></span>Create Responses</a
      >
      <div style="padding-top: 15px">
        <input
          id="btnCancel"
          type="button"
          class="ms-ButtonHeightWidth"
          value="Close"
          title="Close"
          onclick="SP.UI.ModalDialog.commonModalDialogClose(SP.UI.DialogResult.cancel)"
        />
      </div>
    </div>
  </div>
`;var n=window.Audit||{};n.BulkAddResponse=n.BulkAddResponse||{};document.readyState==="ready"||document.readyState==="complete"?te():document.onreadystatechange=()=>{(document.readyState==="complete"||document.readyState==="ready")&&ExecuteOrDelayUntilScriptLoaded(function(){SP.SOD.executeFunc("sp.js","SP.ClientContext",te)},"sp.js")};function te(){document.getElementById("app").innerHTML=ee,n.BulkAddResponse.Report=new n.BulkAddResponse.Load,n.BulkAddResponse.Init()}n.BulkAddResponse.Init=function(){};n.BulkAddResponse.Load=function(){var y=GetUrlKeyValue("ReqNum");if(y==null||y==""||y==null){statusId=SP.UI.Status.addStatus("Error: Request Number was not specified. Please verify the URL Parameters or Launch from the IA Dashboard"),SP.UI.Status.setStatusPriColor(statusId,"red");return}$("#divRequestNumber").text(y);var A=null,P=new Array,M=new Array,w=new Array,x=null,B,V,q,Q,E,F,ie=null,ae=null,ne=null;se();function se(){$("#divTblOutput").html("");var i=new SP.ClientContext.get_current,t=i.get_web(),e=t.get_lists().getByTitle(n.Common.Utilities.GetListTitleRequests()),a=new SP.CamlQuery;a.set_viewXml('<View><Query><OrderBy><FieldRef Name="Title"/></OrderBy></Query></View>'),B=e.getItems(a),i.load(B,"Include(ID, Title, ReqSubject, ReqStatus, IsSample, ReqDueDate, InternalDueDate, ActionOffice)");var c=t.get_lists().getByTitle(n.Common.Utilities.GetListTitleResponses()),g=new SP.CamlQuery;g.set_viewXml('<View Scope="RecursiveAll"><Query><OrderBy><FieldRef Name="ReqNum"/></OrderBy></Query></View>'),V=c.getItems(g),i.load(V,"Include(ID, Title, ReqNum, ActionOffice, SampleNumber)");var S=t.get_lists().getByTitle(n.Common.Utilities.GetLibTitleResponseDocs()),p=new SP.CamlQuery;p.set_viewXml('<View><Query><OrderBy><FieldRef Name="Name"/></OrderBy><Where><Eq><FieldRef Name="FSObjType" /><Value Type="Lookup">1</Value></Eq></Where></Query></View>'),p.set_folderServerRelativeUrl(n.Common.Utilities.GetSiteUrl()+"/"+n.Common.Utilities.GetLibNameResponseDocs()),q=S.getItems(p),i.load(q,"Include( DisplayName, Id, ContentType)");var R=t.get_lists().getByTitle(n.Common.Utilities.GetListTitleActionOffices()),l=new SP.CamlQuery;l.set_viewXml('<View><Query><OrderBy><FieldRef Name="Title"/></OrderBy></Query></View>'),Q=R.getItems(l),i.load(Q,"Include(ID, Title, UserGroup)");var o=i.get_web().get_lists().getByTitle(n.Common.Utilities.GetListNameBulkResponses());E=o.get_views().getByTitle("All Items"),i.load(E),F=t.get_siteGroups(),i.load(F);var u=t.get_associatedOwnerGroup(),h=t.get_associatedMemberGroup(),f=t.get_associatedVisitorGroup();i.load(u),i.load(h),i.load(f),i.executeQueryAsync(C,s);function C(D,m){if($("#divLoadSettings").show(),$("#divLoading").hide(),x=E.get_id(),n.Common.Utilities.LoadSiteGroups(F),n.Common.Utilities.LoadActionOffices(Q),ie=u.get_title(),ae=h.get_title(),ne=f.get_title(),re(),A==null||A.number==null){statusId=SP.UI.Status.addStatus("Error: Request Number does not exist in the Request List. Please verify the URL Parameters and that the Request Number already exists"),SP.UI.Status.setStatusPriColor(statusId,"red"),$("#divLoadSettings").hide();return}le(),de(),ce();var v=GetUrlKeyValue("IsDlg");(v==null||v==""||v==!1)&&$("#btnRefresh").show()}function s(D,m){$("#divLoading").hide(),statusId=SP.UI.Status.addStatus("Request failed: "+m.get_message()+`
`+m.get_stackTrace()),SP.UI.Status.setStatusPriColor(statusId,"red")}}function oe(){var i=location.pathname,t=$("#tabs").tabs("option","active");i+="?Tab="+t,location.href=i}function re(){for(var i=SP.ClientContext.get_current(),t=i.get_web(),e=B.getEnumerator();e.moveNext();){var a=e.get_current(),c=a.get_item("ID"),g=a.get_item("Title");if(g==y){for(var S=a.get_item("ReqStatus"),p=a.get_item("IsSample"),R=a.get_item("ActionOffice"),l="",o=0;o<R.length;o++)l+="<div>"+R[o].get_lookupValue()+"</div>";var u=new Object;u.ID=c,u.number=g,u.status=S,u.sample=p,u.responses=new Array,u.actionOffice=l,u.item=a,A=u}}}function le(){P=new Array;for(var i=V.getEnumerator();i.moveNext();){var t=i.get_current(),e=t.get_item("ReqNum");if(e!=null){if(e=e.get_lookupValue(),e!=y)continue;var a=new Object;a.ID=t.get_item("ID"),a.number=e,a.title=t.get_item("Title"),a.item=t,a.sample=t.get_item("SampleNumber"),a.sample==null&&(a.sample=""),a.actionOffice=t.get_item("ActionOffice"),a.actionOffice==null?a.actionOffice="":a.actionOffice=a.actionOffice.get_lookupValue(),P.push(a)}}}function de(){for(var i=new Array,t=q.getEnumerator();t.moveNext();)for(var e=t.get_current(),a=e.get_displayName(),c=0;c<P.length;c++)if(P[c].title==a){var g=new Object;g.title=a,g.response=P[c],i.push(g);break}}function ue(){var i="DispForm.aspx",t=SP.UI.$create_DialogOptions();t.title="Upload Responses ("+y+")",t.dialogReturnValueCallback=ge;var e=x.toString();e=e.replace(/-/g,"%2D"),e=e.toUpperCase(),t.url=n.Common.Utilities.GetSiteUrl()+"/Lists/"+n.Common.Utilities.GetListNameBulkResponses()+"/AllItems.aspx?ShowInGrid=True&View=%7B"+e+"%7D",t.height=700,SP.UI.ModalDialog.showModalDialog(t)}var W={isNotEmpty:function(i){var t=/\S+/;return t.test(i)},isNumber:function(i){var t=/^\d+$/;return t.test(i)}};function X(){w=new Array;var i=new SP.ClientContext.get_current,t=i.get_web(),e=t.get_lists().getByTitle(n.Common.Utilities.GetListTitleBulkResponses()),a=new SP.CamlQuery;a.set_viewXml('<View><Query><OrderBy><FieldRef Name="ID"/></OrderBy></Query></View>');var c=e.getItems(a);i.load(c,"Include(ID, Title, ActionOffice, Comments, POC, POCCC)");function g(p,R){for(var l=c.getEnumerator();l.moveNext();){var o=l.get_current(),u=o.get_item("ID"),h=o.get_item("Title"),f=o.get_item("ActionOffice").get_lookupValue(),C=o.get_item("Comments");C==null&&(C="");var s=new Object;s.ID=u,s.sampleNumber=h,s.actionOffice=f,s.comments=C;var D=y+"-"+f+"-"+h;s.responseTitle=D,s.item=o,f&&f.toLowerCase().indexOf("fpra")<0?(s.poc="",s.poccc="",s.pocID="",s.pocccID=""):(s.poc="",s.poccc="",s.pocID="",s.pocccID="",o.get_item("POC")!=null&&o.get_item("POC").get_lookupValue()!=null&&(s.poc=o.get_item("POC").get_lookupValue(),s.pocID=o.get_item("POC").get_lookupId()),o.get_item("POCCC")!=null&&o.get_item("POCCC").get_lookupValue()!=null&&(s.poccc=o.get_item("POCCC").get_lookupValue(),s.pocccID=o.get_item("POCCC").get_lookupId()));var m=!0,v=null;if((!W.isNotEmpty(h)||!W.isNumber(h))&&(m=!1,v="Invalid sample number"),m){for(var r=0;r<P.length;r++)if(P[r].title==D){m=!1,v="Response with this name exists";break}}if(m){for(var r=0;r<M.length;r++)if(M[r].title==D){m=!1,v="Response Folder with this name exists";break}}if(m){for(var _=!1,r=0;r<n.Common.Utilities.GetActionOffices().length;r++)n.Common.Utilities.GetActionOffices()[r].title==f&&(s.actionOfficeID=n.Common.Utilities.GetActionOffices()[r].ID,_=!0);_||(m=!1,v="Action Office not found")}s.isValid=m,s.invalidReason=v,w.push(s)}var O=!1;w.sort(function(b,T){return b=parseInt(b.sampleNumber,10),T=parseInt(T.sampleNumber,10),b-T});for(var U="<table class='tablesorter report'><tr><thead><th>Request Number</th><th>Action Office</th><th>Sample Number</th><th>Response Title</th><th>Comments</th><th>POC</th><th>POC CC</th></thead></tr>",r=0;r<w.length;r++){var d=w[r];d.isValid?(U+="<tr id='tableRow"+r+"'><td id='tdReq"+r+"'>"+y+"</td><td>"+d.actionOffice+"</td><td>"+d.sampleNumber+"</td><td>"+d.responseTitle+"</td><td>"+d.comments+"</td><td>"+d.poc+"</td><td>"+d.poccc+"</td></tr>",O=!0):U+="<tr style='background-color:lightsalmon; font-style:italic;' title='"+d.invalidReason+"'><td>"+y+"</td><td>"+d.actionOffice+"</td><td>"+d.sampleNumber+"</td><td>"+d.responseTitle+" - "+d.invalidReason+"</td><td>"+d.comments+"</td><td>"+d.poc+"</td><td>"+d.poccc+"</td></tr>"}$("#divLoadBulkResponsesOutput").html(U+="<tfoot><tr><th colspan='7'>Total: "+w.length+"</tr></tfoot></table>"),w.length==0&&$("#divLoadBulkResponsesOutput").html(""),O?$("#btnCreateResponses").show().focus():$("#btnCreateResponses").hide()}function S(p,R){statusId=SP.UI.Status.addStatus("Unable to load from the Bulk Response List: "+R.get_message()+`
`+R.get_stackTrace()),SP.UI.Status.setStatusPriColor(statusId,"red")}i.executeQueryAsync(g,S)}var I=0,N=0,G=null,k=!0;function me(){if(k=!0,confirm("Are you sure you would like to Create the Responses?")){$("#btnUploadResponses").hide(),$("#btnCreateResponses").hide(),$("#divLoadSettings").hide(),$("#btnCancel").hide(),document.body.style.cursor="wait",window.parent!=null&&window.parent.document.getElementById("divRanBulkUpdate")!=null&&(window.parent.document.getElementById("divRanBulkUpdate").innerText=1),G=SP.UI.ModalDialog.showWaitScreenWithNoClose("Creating Responses","Please wait... Creating Responses",200,400);for(var i=0;i<w.length;i++){var t=w[i];if(t.isValid){let fe=function(_e,Z){k&&(n.Common.Utilities.CheckIfEmailFolderExists(this.emailListFolderItems,this.requestNumber)||n.Common.Utilities.CreateEmailFolder(this.emailList,this.requestNumber),k=!1),$("#tableRow"+this.tableRowId).attr("style","background-color:palegreen"),$("#tableRow"+this.tableRowId).attr("title","Created"),$("#tdReq"+this.tableRowId).html("<span class='ui-icon ui-icon-check'></span> "+$("#tdReq"+this.tableRowId).text());var j=new SP.ClientContext.get_current,L=w[this.tableRowId].ID;if(L!=null&&L>=0){var ye=j.get_web().get_lists().getByTitle(n.Common.Utilities.GetListTitleBulkResponses()),we=ye.getItemById(L);we.deleteObject()}j.executeQueryAsync(function(){if(N++,I==N){document.body.style.cursor="default",G.close();var Re=SP.UI.Notify.addNotification("Completed",!1);$("#btnCancel").show()}},function(){if(N++,I==N){document.body.style.cursor="default",G.close();var Re=SP.UI.Notify.addNotification("Completed",!1);$("#btnCancel").show()}})},ve=function(_e,Z){$("#tableRow"+this.tableRowId).attr("style","background-color:salmon"),$("#tableRow"+this.tableRowId).attr("title",Z.get_message()),N++,I==N&&(document.body.style.cursor="default",G.close(),notifyId=SP.UI.Notify.addNotification("Completed",!1),$("#btnCancel").show())};I++;var e=new SP.ClientContext.get_current,a=e.get_web().get_currentUser(),c=e.get_web().get_associatedOwnerGroup(),g=e.get_web().get_associatedMemberGroup(),S=e.get_web().get_associatedVisitorGroup(),p=t.responseTitle,R=e.get_web().get_lists().getByTitle(n.Common.Utilities.GetListTitleResponses()),r=new SP.ListItemCreationInformation,l=R.addItem(r);if(l.set_item("Title",p),l.set_item("ReqNum",A.ID),l.set_item("SampleNumber",t.sampleNumber),l.set_item("ActionOffice",t.actionOfficeID),t.poc!=""){var o=new SP.FieldUserValue;o.set_lookupId(t.pocID),l.set_item("POC",o)}if(t.poccc!=""){var o=new SP.FieldUserValue;o.set_lookupId(t.pocccID),l.set_item("POCCC",o)}l.update(),l.breakRoleInheritance(!1,!1);var u=SP.RoleDefinitionBindingCollection.newObject(e);u.add(e.get_web().get_roleDefinitions().getByType(SP.RoleType.administrator));var h=SP.RoleDefinitionBindingCollection.newObject(e);h.add(e.get_web().get_roleDefinitions().getByType(SP.RoleType.contributor));var f=SP.RoleDefinitionBindingCollection.newObject(e);f.add(e.get_web().get_roleDefinitions().getByName("Restricted Read"));var C=SP.RoleDefinitionBindingCollection.newObject(e);C.add(e.get_web().get_roleDefinitions().getByName("Restricted Contribute")),l.get_roleAssignments().add(c,u),l.get_roleAssignments().add(g,h),l.get_roleAssignments().add(S,f);var s=l.get_item("ActionOffice");if(s!=null){var D=t.actionOffice,b=n.Common.Utilities.GetAOSPGroupName(D),m=n.Common.Utilities.GetSPSiteGroup(b);if(m!=null)l.get_roleAssignments().add(m,C);else return}l.get_roleAssignments().getByPrincipal(a).deleteObject();var v=e.get_web().get_lists().getByTitle(n.Common.Utilities.GetLibTitleResponseDocs()),r=new SP.ListItemCreationInformation;r.set_underlyingObjectType(SP.FileSystemObjectType.folder),r.set_leafName(p);var _=v.addItem(r);_.set_item("Title",p),_.update(),_.breakRoleInheritance(!1,!1);var O=SP.RoleDefinitionBindingCollection.newObject(e);O.add(e.get_web().get_roleDefinitions().getByType(SP.RoleType.administrator)),_.get_roleAssignments().add(c,O);var U=SP.RoleDefinitionBindingCollection.newObject(e);U.add(e.get_web().get_roleDefinitions().getByType(SP.RoleType.contributor)),_.get_roleAssignments().add(g,U);var d=SP.RoleDefinitionBindingCollection.newObject(e);d.add(e.get_web().get_roleDefinitions().getByName("Restricted Read")),_.get_roleAssignments().add(S,d);var b=n.Common.Utilities.GetAOSPGroupName(t.actionOffice),T=n.Common.Utilities.GetSPSiteGroup(b);if(T!=null){var H=SP.RoleDefinitionBindingCollection.newObject(e);H.add(e.get_web().get_roleDefinitions().getByName("Restricted Contribute")),_.get_roleAssignments().add(T,H)}_.get_roleAssignments().getByPrincipal(a).deleteObject();var K=e.get_web().get_lists().getByTitle(n.Common.Utilities.GetListTitleEmailHistory()),z=new SP.CamlQuery;z.set_viewXml('<View><Query><OrderBy><FieldRef Name="ID"/></OrderBy><Where><Eq><FieldRef Name="FSObjType"/><Value Type="Text">1</Value></Eq></Where></Query></View>');var J=K.getItems(z);e.load(J,"Include(ID, FSObjType, Title, DisplayName)");var Y={responseTitle:p,requestNumber:A.number,tableRowId:i,emailList:K,emailListFolderItems:J};e.executeQueryAsync(Function.createDelegate(Y,fe),Function.createDelegate(Y,ve))}}}}function ce(){$("#btnUploadResponses").click(function(){ue()}),$("#btnLoadResponses").click(function(){X()}),$("#btnCreateResponses").click(function(){me()})}function ge(i,t){X()}var pe={Refresh:oe};return pe};})();
